# 💹 IA-FINANCIERA · ETL → Machine Learning → KPIs & Visuals

[![Python](https://img.shields.io/badge/Python-3.10%2B-3776AB)](https://www.python.org/)
[![pandas](https://img.shields.io/badge/pandas-2.x-150458)](https://pandas.pydata.org/)
[![scikit-learn](https://img.shields.io/badge/scikit--learn-1.x-f7931e)](https://scikit-learn.org/)
[![streamlit](https://img.shields.io/badge/Streamlit-Dashboard-E64A19)](https://streamlit.io/)

**End-to-end ML project** for financial market direction. It extracts and transforms OHLCV time series, engineers technical indicators, trains classifiers, and produces **UP/DOWN** signals with KPIs and visuals.

> Data source: **Yahoo Finance** via `yfinance`. Visuals are generated from the transformed dataset (not from raw data).

---

## 🧭 Table of Contents
- [Goal](#goal)
- [Preview](#preview)
- [Features](#features)
- [Architecture](#architecture)
- [Star Schema](#star-schema)
- [Data Dictionary](#data-dictionary)
- [Install & Run](#install--run)
- [Configuration (`config.yaml`)](#configuration-configyaml)
- [KPIs & Model Details](#kpis--model-details)
- [Dashboard](#dashboard)
- [Backtest (optional)](#backtest-optional)
- [Reproducibility & Logging](#reproducibility--logging)
- [Troubleshooting](#troubleshooting)
- [FAQ](#faq)
- [Roadmap](#roadmap)
- [License & Disclaimer](#license--disclaimer)
- [Credits](#credits)

---

## 🎯 Goal
- Implement a clean **ETL → ML** pipeline for **direction classification**.
- Predict **PROBA_UP** (probability of next move UP) via an **ensemble**.
- Report **Top-N bullish / bearish** and a compact **probability summary**.
- Generate a **heatmap** preview and an optional **interactive dashboard**.

---

## 🖼️ Preview
<p align="center">
  <img src="images/heatmap_probs.png" alt="Probability Heatmap (Ensemble / Models)" width="70%" />
</p>
<p align="center">
  <em>Generated by <code>scripts/plot_heatmap.py</code> → <code>images/heatmap_probs.png</code></em>
</p>

---

## ✨ Features
- 🔁 **ETL**: download, transform, deduplicate, and enrich OHLCV time series.
- 🧪 **Indicators**: RSI, MACD, EMA/SMA, Bollinger Bands, ATR, etc.
- 🤖 **Classification**: LogisticRegression + RandomForest → **Ensemble (PROBA_UP)**.
- 📊 **Top-N** (calls/puts), `models/prob_summary.csv`, **colored console** output.
- 🖼️ **Heatmap PNG** for quick overview.
- 🖥️ **Streamlit dashboard** (interactive, optional).
- 🧾 **Logging** (with auto-cleanup) + light **seed** utilities.

---

## 🏗️ Architecture

### Data Flow
```mermaid
flowchart LR
  A[yfinance tickers] --> B[etl/extract.py]
  B --> C[etl/transform.py]
  C --> D[etl/load.py]
  D --> R[data/raw/*.csv]
  R --> E[models/train_all.py]
  R --> F[models/train_direction.py]
  F --> S[models/prob_summary.csv]
  F --> T[models/traces/*.csv]
  S --> H[images/heatmap_probs.png]
  S --> W[apps/dashboard_app.py]
````

---

## 🧱 Star Schema

```mermaid
erDiagram
  SIGNALS {
    datetime datetime
    string   ticker
    float    proba_logreg
    float    proba_rf
    float    proba_ens
    string   pred
  }

  TICKER {
    string ticker
    string asset_class
  }

  DATE {
    datetime datetime
    int      year
    int      month
    int      day
  }

  MODEL {
    string name
    string type
    string notes
  }

  SIGNALS ||--o{ TICKER : has
  SIGNALS ||--o{ DATE   : occurs_on
  SIGNALS ||--o{ MODEL  : generated_by
```

---

## 📚 Data Dictionary

### `models/prob_summary.csv`

| Column         | Type   | Description                             |
| -------------- | ------ | --------------------------------------- |
| `ticker`       | string | Symbol (e.g., SPY, AAPL, BTC-USD)       |
| `date`         | date   | Date of prediction                      |
| `proba_logreg` | float  | Probability of UP (Logistic Regression) |
| `proba_rf`     | float  | Probability of UP (Random Forest)       |
| `proba_ens`    | float  | Ensemble probability (weighted avg)     |
| `pred`         | string | Final direction: `UP` / `DOWN`          |

### `data/raw/<TICKER>_<interval>.csv` (transformed OHLCV + features)

Typical columns: `Datetime`, `Ticker`, `Open`, `High`, `Low`, `Close`, `Volume`, `Interval`, plus engineered features (`rsi14`, `macd`, `ema_*`, `sma_*`, `bb_*`, `atr14`, etc.).

### `models/traces/*_trace.csv` (optional)

Per-ticker classification traces: timestamps, predicted direction, next returns (when available) for simple signal backtesting.

---

## ⚙️ Install & Run

```bash
# 1) Clone
git clone https://github.com/ShadowBlack33/ia-financiera.git
cd ia-financiera

# 2) Virtual env
python -m venv .venv
.venv\Scripts\activate           # Windows
# source .venv/bin/activate      # macOS/Linux

# 3) Dependencies
pip install -r requirements.txt

# 4) Run the full pipeline (ETL → Train → Predict)
python menu.py
# It will ask: start/end dates and whether to save the CSV summary

# 5) Generate the preview heatmap
python scripts/plot_heatmap.py   # → images/heatmap_probs.png
```

> If `images/` is ignored by `.gitignore`, allow this preview file with:
>
> ```
> images/*
> !images/heatmap_probs.png
> !images/.gitkeep
> ```

---

## ⚙️ Configuration (`config.yaml`)

Minimal example (keys may already exist in your repo):

```yaml
# Dates & interval
start_date: "2015-01-01"
end_date: ""            # empty = up to latest
interval: "1d"          # valid: 1d, 1wk, 1mo, etc.

# Data & features
data_dir: "data/raw"
default_top_n: 10
features:
  rsi:
    periods: [14]
  macd:
    fast: 12
    slow: 26
    signal: 9
  sma:
    windows: [10, 20, 50, 200]
  ema:
    windows: [12, 26]
  bollinger:
    window: 20
    n_std: 2
  atr:
    window: 14
```

---

## 📊 KPIs & Model Details

* **PROBA\_UP (ensemble):** by default a weighted average of model probabilities (e.g., 0.5·LogReg + 0.5·RF), configurable in code.
* **Top-N Calls/Puts:** ranks tickers by `proba_ens` (descending for calls / ascending for puts).
* **Console colors:** highlights UP/DOWN rows for quick scanning.
* **Split strategy:** hold-out on last `N` samples (e.g., `test_size=200`) with `horizon=1`.
* **Embargo (regression):** e.g., 5 bars to reduce leakage in regression evaluation.

> Note: This is an educational project; you can replace/extend models (XGBoost, LightGBM), add walk-forward CV, or calibrate probabilities.

---

## 🖥️ Dashboard

```bash
streamlit run apps/dashboard_app.py
```

Includes:

* Top-N bullish & bearish lists
* Probability heatmap (LogReg / RF / Ensemble)
* Detailed summary table

---

## 📈 Backtest (optional)

```bash
python -m models.backtest
```

Produces CSV summaries and (optionally) PNG plots under `reports/` if traces/preds exist.

---

## 🔁 Reproducibility & Logging

* Lightweight seed utility (`utils/seed.py`) — optional.
* Log rotation / cleanup via `utils/log_cleanup.py` to keep `logs/` tidy.
* `.gitignore` prevents committing large generated artifacts; allow selected previews for README.

---

## 🛠️ Troubleshooting

* **Mermaid errors in README:** ensure diagrams are inside fenced code blocks with `mermaid`, and avoid comments (`//`) or special characters inside nodes.
* **`images/heatmap_probs.png` not showing on GitHub:** it may be ignored by `.gitignore`. Add:

  ```
  images/*
  !images/heatmap_probs.png
  !images/.gitkeep
  ```

  Then:

  ```
  git add -f images/heatmap_probs.png
  git commit -m "Add README preview (heatmap)"
  git push
  ```
* **NaNs during training:** check feature generation; run the ETL for a wider date range or adjust feature windows. You can impute/drop rows before fitting.
* **Streamlit error (file not found):** ensure `models/prob_summary.csv` exists (run `menu.py` first).
* **Rate limits / network errors:** re-run ETL; the menu includes automatic retries per ticker.

---

## ❓ FAQ

**How do I add new tickers?**
Add them to your presets (or just run ETL with your desired symbols). The menu aggregates all preset lists.

**How do I change `Top-N`?**
Edit `default_top_n` in `config.yaml` (or the parameter used in `train_direction.py`).

**Can I change the bar interval?**
Yes: set `interval` in `config.yaml` (e.g., `1d`, `1wk`, `1mo`).

**Where are outputs saved?**

* Transformed CSVs → `data/raw/`
* Classification summary → `models/prob_summary.csv`
* Traces → `models/traces/`
* Heatmap preview → `images/heatmap_probs.png`

---

## 🗺️ Roadmap

* Walk-forward CV and proper time-series splits
* Probability calibration (Platt / Isotonic)
* More models (XGBoost, LightGBM) and stacking
* Position sizing / portfolio rules
* Risk metrics and drawdown charts
* Model registry & versioning

---

## 📜 License & Disclaimer

**MIT © 2025 — ShadowBlack33**

This repository is for educational purposes only and **does not constitute financial advice**. Use at your own risk.

---

## 👤 Credits

**Carlos Andrés Orozco Caicedo** — Data Engineering & AI — Colombia 🇨🇴